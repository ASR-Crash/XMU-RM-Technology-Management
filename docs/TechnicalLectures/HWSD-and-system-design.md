# 硬件标准化与系统设计

## 前言

硬件标准化与系统设计包括**硬件标准化概述**和**基于硬件标准化的系统设计**两个部分，第一部分针对硬件标准化是什么，为什么要做硬件标准化，以及如何实现硬件标准化三个方面进行阐述；第二部分讲述硬件标准化体系，并以实际兵种案例说明如何利用硬件标准化优势简化系统设计，提高系统稳定性。

----

## Part 1：硬件标准化概述

### 硬件标准化定位

**硬件标准化，是为了解决机器人队硬件迭代和技术传承问题而提出的解决方案。**硬件迭代问题源于两个方面，一是机器人迭代，二是比赛规则更变，两方面的本质都指向同一点：**硬件需求更变**。硬件需求更变最有可能且最直接的体现是硬件接口更变。硬件接口更变，包括接口种类，引脚数和数量的更变，在导致前一代电路板被废弃的同时耗费了时间成本。技术传承问题，是指经过信号完整性和电源完整性分析之后针对PCB layout进行的优化，因为硬件迭代问题，难以延用到下一赛季，后继者无法将设计案例快速转化为解决方案予以应用。

**机器人通用的硬件方案，是硬件标准化最直观的理解。**主控板+扩展板的模式，既能通过管脚复用改变接口定义，实现接口复用，提高硬件方案通用性，又能通过不同扩展板与主控板的组合，为快速构建硬件方案提供了可能性。

**硬件标准化的核心思路是以统一接口为基础，以模块化的方法，实现硬件标准化。**通过定义硬件接口功能、线序等属性，将所需外设模块从主控板中分离并设计为扩展板，提取主控板核心功能，简化主控板设计，降低外设与主控的耦合度，从而最大限度避免不必要的硬件迭代，同时后续改进工作可基于标准化的主控板进行，硬件迭代和技术传承问题迎刃而解。

### 硬件系统稳定性

**提高硬件系统稳定性，是硬件标准化一个重要研发目的。**硬件系统稳定性包括两方面，板级稳定性和连接稳定性。

板级稳定性从PCB元器件、layout角度考虑，PCB元器件角度体现在耐压是否足够、阻值容值等参数是否合适，以及是否具有针对集成电路的AEC-Q100认证，针对分立半导体器件的AEC-Q101认证，针对无源器件的AEC-Q200认证。机器人的工作环境与汽车相似，选择汽车级认证器件是提高稳定性的有效措施。

| AEC-Q100                                                     | AEC-Q101                                                     | AEC-Q102                                                     | AEC-Q104                                                     | AEC-Q200                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Failure Mechanism Based Stress Test Qualification for Integrated Circuit | Failure Mechanism Based Stress Test Qualification for Discrete Semiconductors In Automotive Applications | Failure Mechanism Based Stress Test Qualification for Discrete Optoelectronic Semiconductors In Automotive Applications | Failure Mechanism Based Stress Test Qualification for Multichip Modules(MCM) In Automotive Applications | Failure Mechanism Based Stress Test Qualification for Passive Components |
| 集成电路 基于失效机理的应力测试验证                          | 分立半导体器件 基于失效机理的应力测试验证                    | 分立光电半导体器件 基于失效机理的应力测试验证                | 多芯片组件 基于失效机理的应力测试验证                        | 被动元件 基于失效机理的应力测试验证                          |

PCB layout角度体现在EMC设计(ElectroMagnetic Compatibility，电磁兼容性)，信号线与电源走线规则。最重要的通信网络——CAN(Controller Area Network，控制器局域网络)，要求差分走线，在PCB上需要遵守等长等距的规则。【CAN总线ISO标准：ISO11898，ISO11519-2】

<table>
    <tr>
        <td><img src="主控板CAN通信 SCH.png"/>
        <td><img src="主控板CAN走线.png"/>
        </td>
    </tr>
</table>

连接稳定性，指的是电路板与电路板之间、电路板与被控组件之间，不会在机器人实现功能过程中出现连接松动、接触不良等问题。电控组常用的接口有4种，XT30、排针、PH2.0、GH1.25。其中，XT30应用于大电流场景，排针通用性最佳，常用于开发板原型开发和调试接口，但是存在连接不稳定的致命隐患。对于信号传输，GH1.25稳定性最高，综上考虑，硬件标准化的切入口——接口类型定义选择了GH1.25。

|        | XT30       | 排针         | PH2.0               | GH1.25              |
| ------ | ---------- | ------------ | ------------------- | ------------------- |
| 稳定性 | 高         | 低           | 中                  | 高                  |
| 载流量 | 30A        | 3A           | 2A                  | 1A                  |
| 应用   | 大电流场景 | 频繁拔插场景 | 信号传输/小电流场景 | 信号传输/小电流场景 |

<table>
    <tr>
        <td><img src="XT30U-F.jpg"/></td>
        <td><img src="排针.jpg"/></td>
        <td><img src="PH2.0.jpg"/></td>
        <td><img src="GH1.25.jpg"/></td>
    </tr>
</table>

### 标准化接口定义

基于连接稳定性的分析，硬件接口的最佳选择是GH1.25；而实现接口复用的必要条件，是接口的引脚（Pin）数量相同且线序一致。在实际测试过程中得出的结论是：6Pin的IO扩展接口和4Pin的CAN扩展接口，最切合目前搭建的机器人系统。标准化接口定义如下表所示：

| 接口\线序            | 1    | 2    | 3    | 4    | 5    | 6    | 数量 |
| -------------------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| **6Pin IO扩展接口**  | 5V   | IO1  | IO2  | IO3  | IO4  | GND  | 4    |
| **4Pin CAN扩展接口** | L    | L    | H    | H    |      |      | 2    |
| 4Pin SWD调试接口     | CLK  | DIO  | GND  | 3V3  |      |      | 1    |
| 4Pin 串行通信接口    | 5V   | TX   | RX   | GND  |      |      | 2    |
| 3Pin 串行通信接口    | TX   | RX   | GND  |      |      |      | 3    |
| 3Pin 舵机接口        | PWM  | 5V   | GND  |      |      |      | 1    |
| 2Pin CAN电机接口     | L    | H    |      |      |      |      | 2    |

<img src="主控板正面位号图.png"/>

----
<div STYLE="page-break-after: always;"></div>
----

## Part 2：基于硬件标准化的系统设计

### 硬件标准化体系
硬件标准化体系由主控板和扩展板构成。目前完成的6种标准化电路板如下表所示：

| Main Control | CAN Station | IO Expansion | Steering Engine | Solenoid Valve | Linear Actuator |
| ------------ | ----------- | ------------ | --------------- | -------------- | --------------- |
| 主控板       | CAN扩展板   | IO扩展板     | 舵机扩展板      | 电磁阀扩展板   | 电动推杆扩展板  |

<img src="硬件标准化体系.PNG"/>

### 硬件设计流程

常规硬件设计流程如下图所示：

<img src="常规硬件设计流程.jpg" />

硬件标准化将硬件框图绘制、原理图设计、PCB设计、可行性验证四个步骤抽象并简化为选择硬件接口。这个概念和嵌入式的代码封装有异曲同工之处。

<img src="硬件标准化系统设计流程.jpg"/>

### 系统设计案例

接下以RM2020哨兵为例，简析如何基于硬件标准化构建系统方案。

- **确定需求和物资清单**

| 结构 | 物资     | 数量 | 物资             | 数量 |
| ---- | -------- | ---- | ---------------- | ---- |
| 底盘 | 3508电机 | 2    | C620电调         | 2    |
|      | 主控板   | 1    | CAN扩展板        | 3    |
|      | NUC      | 1    | 24V转19V降压模块 | 1    |
|      | 24V电池  | 1    |                  |      |
| 云台 | 3508电机 | 4    | C620电调         | 4    |
|      | 2006电机 | 2    | C610电调         | 2    |
|      | 6020电机 | 4    | 激光             | 2    |
|      | 摄像头   | 2    |                  |      |

| 物资清单 | 物资     | 数量 | 物资             | 数量 |
| -------- | -------- | ---- | ---------------- | ---- |
| 电机类   | 3508电机 | 6    | C620电调         | 6    |
|          | 2006电机 | 2    | C610电调         | 2    |
|          | 6020电机 | 4    |                  |      |
| PCB类    | 主控板   | 1    | CAN扩展板        | 3    |
| 电源类   | 24V电池  | 1    | 24V转19V降压模块 | 1    |
| 视觉类   | NUC      | 1    | 摄像头           | 2    |
|          | 激光     | 2    |                  |      |

哨兵总共需要12个电机，没有其他执行器，只需要1 * 主控板 + 3 * CAN扩展板即可实现基本功能。

- **绘制电路框图**

<img src="哨兵-电路框图.jpg"/>

- **选择硬件接口**

由于哨兵的执行器全部是CAN通信，因此只需要连接CAN1和CAN2两个扩展接口。

<img src="哨兵-硬件接口.png" />

由于RM2020哨兵只使用了CAN电机的特殊性，此部分再以RM2019工程为例进行展开

<img src="RM2019-工程-电路框图.jpg" />

从RM2019工程电路框图中提取出的硬件需求：

| 二位电磁阀 | 5    | 三位电磁阀 | 1    | 所需IO       | 7    |
| ---------- | ---- | ---------- | ---- | ------------ | ---- |
| CAN1电机   | 6    | CAN2电机   | 6    | 所需电机接口 | 12   |
| 红外对管   | 2    |            |      | 所需IO       | 2    |
| 树莓派通信 | 1    |            |      | 所需串口     | 1    |

转化为硬件标准化方案：

|      | 主控板 | CAN扩展板 | 电磁阀扩展板 | IO扩展板 |
| ---- | ------ | --------- | ------------ | -------- |
| 数量 | 1      | 3         | 2            | 1        |

工程硬件系统连接Demo：

<img src="工程Demo.png" />

- **确定硬件位置**

硬件标准化对板子的外形进行了定义：

|      | 主控板  | 扩展板  | CAN Station  |
| ---- | ------- | ------- | ------------ |
| 长   | 85.60mm | 50.00mm | 直径 56.60mm |
| 宽   | 53.98mm | 30.00mm |              |

据此，电控组可根据结合图纸确定硬件位置，哨兵示例如图：

<img src="哨兵-主控位置.png" />

<img src="哨兵-扩展板位置.png" />

硬件位置确定后，即可评估走线长度，进行布线优化。标准化接口定义了Pin数，使得对应连接线能够批量定制，一方面有效降低连接线定制成本，另一方面相比于自制连接线的连接稳定性有很好的提升。

至此，一个基于硬件标准化的硬件系统搭建完毕。

---

<p align='right'><font color=gray><strong>作者：罗上聪</strong></font></p>
---

<img src='https://img.wenhairu.com/images/2020/10/18/CbAIj.png'  >

